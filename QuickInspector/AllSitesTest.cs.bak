using System.Net.Http;
using HtmlAgilityPack;
using ListingMonitor.Infrastructure.Scraping.Adapters;

namespace ListingMonitor.Test;

public class AllSitesTest
{
    public static async Task Main(string[] args)
    {
        Console.WriteLine("ğŸŒ TÃ¼m Siteler Scraping Testi");
        Console.WriteLine("==============================");
        
        var adapters = new List<ISiteAdapter>
        {
            new YouthallAdapter(),
            new MicrofonAdapter(),
            new BursverenlerAdapter(),
            new IlanburdaAdapter()
        };
        
        var allListings = new List<(string Source, int Count)>();
        
        foreach (var adapter in adapters)
        {
            try
            {
                Console.WriteLine($"\nğŸš€ {adapter.SourceName.ToUpper()} scraping baÅŸlatÄ±lÄ±yor...");
                
                // Availability kontrolÃ¼
                var isAvailable = await adapter.IsAvailableAsync();
                Console.WriteLine($"   ğŸ“¡ Site durumu: {(isAvailable ? "âœ… Aktif" : "âŒ Pasif")}");
                
                if (!isAvailable)
                {
                    Console.WriteLine($"   âš ï¸ {adapter.SourceName} sitesine ulaÅŸÄ±lamÄ±yor, atlanÄ±yor...");
                    continue;
                }
                
                var listings = await adapter.ScrapeAsync();
                
                Console.WriteLine($"   ğŸ“Š SonuÃ§: {listings.Count} kayÄ±t Ã§ekildi");
                
                if (listings.Any())
                {
                    Console.WriteLine($"   ğŸ† Ä°lk 3 kayÄ±t:");
                    foreach (var listing in listings.Take(3))
                    {
                        Console.WriteLine($"      â€¢ {listing.Title}");
                        Console.WriteLine($"        ğŸ¢ {listing.Company}");
                        Console.WriteLine($"        ğŸ”— {listing.Url}");
                        if (!string.IsNullOrWhiteSpace(listing.Description))
                        {
                            Console.WriteLine($"        ğŸ“ {listing.Description}");
                        }
                        Console.WriteLine();
                    }
                }
                
                allListings.Add((adapter.SourceName, listings.Count));
                
                // Rate limiting between sites
                await Task.Delay(2000);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"   âŒ {adapter.SourceName} hatasÄ±: {ex.Message}");
                allListings.Add((adapter.SourceName, 0));
            }
            finally
            {
                adapter.Dispose();
            }
        }
        
        // Ã–zet
        Console.WriteLine("\nğŸ¯ TOPLAM Ã–ZET");
        Console.WriteLine("================");
        var totalListings = allListings.Sum(x => x.Count);
        
        foreach (var (source, count) in allListings)
        {
            Console.WriteLine($"   {source.PadRight(15)}: {count} kayÄ±t");
        }
        
        Console.WriteLine($"   {new string('-', 15)}: -");
        Console.WriteLine($"   {"TOPLAM".PadRight(15)}: {totalListings} kayÄ±t");
        
        if (totalListings > 0)
        {
            Console.WriteLine("\nâœ… TÃœM SÄ°TELER BAÅARILI! Veriler Ã§ekildi.");
            Console.WriteLine("ğŸ‰ ArtÄ±k bu adapter'lar mevcut sisteme entegre edilebilir!");
        }
        else
        {
            Console.WriteLine("\nâŒ HiÃ§ veri Ã§ekilemedi. Site yapÄ±larÄ± deÄŸiÅŸmiÅŸ olabilir.");
        }
        
        Console.WriteLine("\nğŸ Test tamamlandÄ±! Ã‡Ä±kmak iÃ§in Enter...");
        Console.ReadLine();
    }
}
