using System.Net.Http;
using HtmlAgilityPack;
using ListingMonitor.Infrastructure.Scraping.Adapters;

namespace ListingMonitor.Test;

public class UpdatedSitesTest
{
    public static async Task Main(string[] args)
    {
        Console.WriteLine("ğŸŒ 3 Aktif Site - GÃ¼ncel DOM Testi");
        Console.WriteLine("===================================");
        
        var adapters = new List<ISiteAdapter>
        {
            new YouthallAdapter(),      // âœ… Ã‡alÄ±ÅŸÄ±yor (86 kayÄ±t)
            new MicrofonAdapter(),      // ğŸ”§ GÃ¼ncellendi
            new BursverenlerAdapter()   // ğŸ”§ GÃ¼ncellendi
        };
        
        var allListings = new List<(string Source, int Count)>();
        
        foreach (var adapter in adapters)
        {
            try
            {
                Console.WriteLine($"\nğŸš€ {adapter.SourceName.ToUpper()} (GÃ¼ncel) scraping baÅŸlatÄ±lÄ±yor...");
                
                // Availability kontrolÃ¼
                var isAvailable = await adapter.IsAvailableAsync();
                Console.WriteLine($"   ğŸ“¡ Site durumu: {(isAvailable ? "âœ… Aktif" : "âŒ Pasif")}");
                
                if (!isAvailable)
                {
                    Console.WriteLine($"   âš ï¸ {adapter.SourceName} sitesine ulaÅŸÄ±lamÄ±yor, atlanÄ±yor...");
                    allListings.Add((adapter.SourceName, 0));
                    continue;
                }
                
                var listings = await adapter.ScrapeAsync();
                
                Console.WriteLine($"   ğŸ“Š SonuÃ§: {listings.Count} kayÄ±t Ã§ekildi");
                
                if (listings.Any())
                {
                    Console.WriteLine($"   ğŸ† Ä°lk 2 kayÄ±t:");
                    foreach (var listing in listings.Take(2))
                    {
                        Console.WriteLine($"      â€¢ {listing.Title}");
                        Console.WriteLine($"        ğŸ¢ {listing.Company}");
                        Console.WriteLine($"        ğŸ”— {listing.Url}");
                        if (!string.IsNullOrWhiteSpace(listing.Description))
                        {
                            Console.WriteLine($"        ğŸ“ {listing.Description}");
                        }
                        Console.WriteLine();
                    }
                }
                
                allListings.Add((adapter.SourceName, listings.Count));
                
                // Rate limiting between sites
                await Task.Delay(2000);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"   âŒ {adapter.SourceName} hatasÄ±: {ex.Message}");
                allListings.Add((adapter.SourceName, 0));
            }
            finally
            {
                adapter.Dispose();
            }
        }
        
        // Ã–zet
        Console.WriteLine("\nğŸ¯ GÃœNCEL SONUÃ‡LAR");
        Console.WriteLine("==================");
        var totalListings = allListings.Sum(x => x.Count);
        
        foreach (var (source, count) in allListings)
        {
            var status = count > 0 ? "âœ…" : "âŒ";
            Console.WriteLine($"   {status} {source.PadRight(15)}: {count} kayÄ±t");
        }
        
        Console.WriteLine($"   {new string('-', 18)}: -");
        Console.WriteLine($"   ğŸ“Š TOPLAM         : {totalListings} kayÄ±t");
        
        if (totalListings > 0)
        {
            Console.WriteLine("\nğŸ‰ BAÅARILI! GÃ¼ncel DOM yapÄ±larÄ± Ã§alÄ±ÅŸÄ±yor.");
            Console.WriteLine("ğŸš€ ArtÄ±k bu 3 adapter mevcut sisteme entegre edilebilir!");
            
            var workingCount = allListings.Count(x => x.Count > 0);
            Console.WriteLine($"ğŸ“ˆ {workingCount}/3 site baÅŸarÄ±yla veri Ã§ekiyor.");
        }
        else
        {
            Console.WriteLine("\nâŒ HiÃ§ veri Ã§ekilemedi. DOM yapÄ±larÄ± tekrar kontrol edilmeli.");
        }
        
        Console.WriteLine("\nğŸ Test tamamlandÄ±! Ã‡Ä±kmak iÃ§in Enter...");
        Console.ReadLine();
    }
}
