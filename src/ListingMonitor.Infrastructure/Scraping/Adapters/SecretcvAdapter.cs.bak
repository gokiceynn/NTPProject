using Microsoft.Playwright;
using ListingMonitor.Infrastructure.Scraping;

namespace ListingMonitor.Infrastructure.Scraping.Adapters;

public class SecretcvAdapter : ISiteAdapter
{
    public string SourceName => "secretcv";
    public string BaseUrl => "https://www.secretcv.com/is-ilanlari";

    public async Task<List<ListingDto>> ScrapeAsync(IPage page)
    {
        var listings = new List<ListingDto>();
        
        try
        {
            // Sayfayı yükle, dynamic content bekle
            await page.GotoAsync(BaseUrl, new PageGotoOptions 
            { 
                WaitUntil = WaitUntilState.NetworkIdle,
                Timeout = 30000 
            });
            
            // "Vitrin İş İlanları" bölümünün yüklenmesini bekle
            await page.Locator("//section[.//text()[contains(., 'Vitrin İş İlanları')]]").WaitForAsync(new LocatorWaitForOptions
            {
                Timeout = 10000
            });
            
            // İlan kartlarını bul
            var jobCards = await page.QuerySelectorAllAsync(
                "//a[contains(@href, '/is-ilanlari/') and not(contains(@href, 'is-ilani-ver'))]"
            );
            
            Console.WriteLine($"Secretcv: {jobCards.Count} ilan kartı bulundu");
            
            foreach (var card in jobCards)
            {
                try
                {
                    var listing = await ExtractListingFromCard(card);
                    if (listing != null)
                    {
                        listings.Add(listing);
                    }
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Secretcv kart işleme hatası: {ex.Message}");
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Secretcv scraping hatası: {ex.Message}");
        }
        
        return listings;
    }
    
    private async Task<ListingDto?> ExtractListingFromCard(IElementHandle card)
    {
        // URL'i al
        var href = await card.GetAttributeAsync("href");
        if (string.IsNullOrWhiteSpace(href))
            return null;
            
        // Başlık elementini bul
        var titleElement = await card.QuerySelectorAsync(".//h2 | .//h3 | .//span[contains(@class,'title')]");
        var title = titleElement != null ? await titleElement.TextContentAsync() : string.Empty;
        
        if (string.IsNullOrWhiteSpace(title))
            return null;
            
        // Şirket adını bul
        var companyElement = await card.QuerySelectorAsync(".//div[contains(@class,'company')] | .//span[contains(@class,'company')]");
        var company = companyElement != null ? await companyElement.TextContentAsync() : string.Empty;
        
        // Lokasyon ve iş tipi bilgisini bul
        var metaElement = await card.QuerySelectorAsync(".//div[contains(@class,'meta')] | .//span[contains(@class,'meta')]");
        var metaText = metaElement != null ? await metaElement.TextContentAsync() : string.Empty;
        
        var listing = new ListingDto
        {
            Source = SourceName,
            Title = title.Trim(),
            Company = company.Trim(),
            Url = new Uri(BaseUrl).GetLeftPart(UriPartial.Authority) + href,
            ExternalId = GenerateExternalId(href),
            Description = metaText.Trim(),
            ListingType = "job"
        };
        
        // Meta text'ten lokasyon ve iş tipi çıkar
        if (!string.IsNullOrWhiteSpace(metaText))
        {
            var metaParts = metaText.Split('·', '·')
                .Select(p => p.Trim())
                .Where(p => !string.IsNullOrWhiteSpace(p))
                .ToList();
                
            if (metaParts.Count >= 1)
                listing.Location = metaParts[0];
                
            if (metaParts.Count >= 2)
                listing.JobType = metaParts[1];
        }
        
        return listing;
    }
    
    private string GenerateExternalId(string url)
    {
        return $"secretcv_{url.GetHashCode()}";
    }
    
    public async Task<bool> IsAvailableAsync(IPage page)
    {
        try
        {
            var response = await page.GotoAsync(BaseUrl, new PageGotoOptions { WaitUntil = WaitUntilState.DOMContentLoaded });
            return response?.Ok == true;
        }
        catch
        {
            return false;
        }
    }
}
